# -*- Mode: nginx; -*-
add_header X-Frame-Options SAMEORIGIN;
add_header X-Content-Type-Options nosniff;
add_header X-XSS-Protection "1; mode=block";

{# defined in vars/main.yml #}
{% for domain, redirect in rewrite_rules %}

server {
    listen 80;
    server_name {{ domain }};
    access_log /var/log/nginx/{{ domain }}-access.log;
    error_log /var/log/nginx/{{ domain }}-error.log;
    include /etc/nginx/snippets/letsencrypt.conf;

    location / {

        {% if ssl %}
        {# Then this file is just a redirect to the HTTPS address #}
        return 301 https://{{ domain }}$request_uri;

        {% else %}
        {# No SSL certificates available, just proxy to location: #}

        # Always HTTP here, because it's local
        proxy_pass http://{{ redirect }};
        {% endif %}

    }
}

{% endfor %}
